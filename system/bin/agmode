#!/system/bin/sh

MODDIR="/data/adb/modules/meZram"
LOGDIR="/data/adb/meZram"
CONFIG="$LOGDIR/meZram.conf"


logger(){
    local td=$(date +%R:%S:%N)
    log=$(echo "$*" | tr -s " ")
    true && echo "$td $log" >> "$LOGDIR"/meZram.log
}


agmode(){
	local agmode_state=$(getprop | grep agmode)
	local starting_line=$(grep -n "#agmode" "$CONFIG" | cut -d ":" -f1)
	local app_pkgs=$(tail -n +$((starting_line + 1)) "$CONFIG")

	if [ -z "$agmode_state" ]; then
		for app in $app_pkgs; do
			local app_pkg=$(echo "$app" | cut -d "=" -f1)
			local dpressure=$(echo "$app" | cut -d "=" -f2)

			logger "app_pkg=$app_pkg"
			logger "running_app=$(pgrep -x "$app_pkg")"

			while true; do
				local fg_app=$(dumpsys activity recents | grep 'Recent #0' | sed 's/.*:\([^ ]*\).*$/\1/')
				local fg_app_=$(pgrep -x "$fg_app")
				local running_app=$(pgrep -x "$app_pkg")

				if [ "$running_app" ] && [[ "$fg_app_" = "$running_app" ]] && [ -z "$am" ]; then
					logger "fg_app_=$fg_app_"
					logger "running_app=$running_app"

					resetprop ro.lmk.downgrade_pressure "$dpressure" && resetprop lmkd.reinit 1

					logger "dpressure=$dpressure"
					logger "agmode activated for $app_pkg"

					local am=true

				elif [ -z "$fg_app_" ] && [ "$am" ]; then
					local default_dpressure=$(sed -n 's/^ro.lmk.downgrade_pressure=//p' "${MODDIR}/system.prop")

					logger "default_dpressure=$default_dpressure"
					resetprop ro.lmk.downgrade_pressure "$default_dpressure" && resetprop lmkd.reinit 1
					logger "default ro.lmk.downgrade_pressure restored"
					unset am

				fi
				sleep 5
			done &
			resetprop meZram.agmode_svc.pid."$app_pkg" "$!" 2> /dev/null
		done
		logger "$(getprop | grep agmode)"
		getprop | grep agmode
		echo "ðŸ˜¾ agmode activated"
	else
		echo "ðŸŽ® agmode already activated"
	fi
}


# Parse command-line options
for opt in "$@"; do
    case "$opt" in
        -g | --get)
			echo "ro.lmk.downgrade_pressure=$(resetprop ro.lmk.downgrade_pressure)"
			;;
        --enable-startup)
			sed -i 's/\(agmode=\).*/\1on/' "$CONFIG" 
			echo "agmode will automatically start next startup"
            ;;
		--disable-startup)
			sed -i 's/\(agmode=\).*/\1off/' "$CONFIG" 
			echo "agmode will be disabled next startup"
			;;
		--stop)
			starting_line=$(grep -n "#agmode" "$CONFIG" | cut -d ":" -f1)                                               app_pkgs=$(tail -n +$((starting_line + 1)) "$CONFIG")

			for app in $app_pkgs; do
				default_dpressure=$(sed -n 's/^ro.lmk.downgrade_pressure=//p' "$MODDIR/system.prop")
				app_pkg=$(echo "$app" | cut -d "=" -f1)

				kill -9 "$(resetprop meZram.agmode_svc.pid."$app_pkg")" 2> /dev/null && echo "agmode for $app_pkg killed"
				resetprop --delete "meZram.agmode_svc.pid.$app_pkg"
			done
			resetprop ro.lmk.downgrade_pressure "$default_dpressure"
			echo "default downgrade_pressure is restored"
			;;
		-h | --help)
			cat "$MODDIR"/man/agmode.txt
			;;
		--log)
			if [ "$2" ]; then 
				watch tail -n "$2" "$LOGDIR"/meZram.log
			else
				watch tail "$LOGDIR"/meZram.log 
			fi
			;;
		--show)
			cat "$CONFIG"
	esac
done


case "$1" in
	downgrade_pressure=*)
		dpressure=$(echo "$1" | sed 's/.*downgrade_pressure=\([0-9]\+\).*/\1/')

		resetprop ro.lmk.downgrade_pressure "$dpressure"
		resetprop lmkd.reinit 1
		echo "ro.lmk.downgrade_pressure=$dpressure"
		sed -i "s/\(downgrade_pressure=\).*/\1$dpressure/" "$MODDIR"/system.prop
		;;
	--add=*)
		if [ "$2" ]; then
			app_name=$(echo "$1" | sed 's/.*--add=\(.*\).*/\1/')

			is_exist=$(grep "^$app_name=[0-9]\{2\}" "$CONFIG")
			echo "$app_name=$2"
			if [ "$is_exist" ]; then
				sed -i "s/\($app_name=\).*/\1$2/" "$CONFIG"
			else
				sed -i "s/\(#agmode.*\)/\1\n$app_name=$2/" "$CONFIG" > /dev/null
				echo "$app_name is added to agmode"
			fi
		else
			echo "Please enter downgrade_pressure"
		fi
		;;
	--delete*)
		if [ "$2" ]; then
			line_num=$(grep -n "$2" "$CONFIG" | cut -d ":" -f1)
			sed -i "${line_num}d" "$CONFIG"
		fi
		;;
esac

if [ -z "$*" ]; then
	echo "agmode can only restarted by reboot for now"
fi
